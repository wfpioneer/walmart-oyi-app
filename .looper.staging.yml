inherit: job:///Mobile/templates-android/androidTemplate-1.3.0

# Maximum commits to be ShallowCloned by Looper
gitShallowDepth: 2147483647

envs:
  global:
    variables:
      # Token generated using SVCintlsamstech service account
      GITHUB_API_TOKEN: 'ENC[QU2juSbwG+R7HO6mSGqUm/FcINIGG7lWFS3KHR7Lkss9/EYkXSuplj0nGZGtTw9/]'
      # Configure react-native-version to only target android
      RNV: android
      # App Center Stage Secret
      APPCENTER_SECRET_STAGE: ENC[Req2tb2fnQEDVCBTf2wSmeUC6uOiTrk8re1nCgNpwb4koA1ezJPDiLQeqEWfJAOE]
      #Template required vars for CI/CD
      # true / false
      AIRWATCH_ACTIVATE: false
      # Cert / Prod
      AIRWATCH_ENV: Prod
      # whether the APK should be built or not
      BUILD_APP_FLAG: true
      # true / false
      DEPLOY_TO_AIRWATCH: false
      # email list where the notification will be sent
      EMAIL_NOTIFICATION: IntlSamsOYI@wal-mart.com

      CONCORD_API_KEY: ENC[OxuAmTCISPiG5JlhDEp5JDQr/CQY2ry7dsbKqBpA2JI=]
      # comma separated file that contains the sites information
      SITES_FILE: sites.txt
      # whether we should use the old version of BUILD_SUPPORT or not. Defaults to false.
      USE_OLD_BUILD_SUPPORT: false

      # determines whether the app should be signed using APK Signature Scheme v2. (Required on Android 11 and up)
      ANDROID_VERSION_ABOVE_11: false

      #Android build vars
      # Optional - if your app needs a special command to be built (release version). Defaults to assembleRelease.
      GRADLEW_BUILD_COMMAND: ':app:assembleStagingRelease'
      # Optional - if your app needs a special command to be built (debug version). Defaults to assembleDebug.
      GRADLEW_BUILD_PR_COMMAND: ':app:assembleStagingDebug'
      # Optional - if your app needs arguments to be built. It's empty by default.
      GRADLEW_ARG: ''

      #ServiceNow variables
      # whether you want the template to create a ServiceNow CHG or not. Defaults to true
      SN_CREATE_AUTO_CHANGE: false
      # The ServiceNow requested_by_group field. No default.
      SN_REQUESTED_BY_GROUP: 'IntlSamsTech'
      # The ServiceNow requested_by_group field. Defaults to Change Managers - US
      SN_CHG_MANAGER_GROUP: "Change Managers - US Sam's"
      # risk level to apply in ServiceNow, from 1 (highest) to 5 (none). Defaults to 5
      SN_RISK: '4'
      # impact level to apply in ServiceNow, from 1 (highest) to 4 (none). Defaults to 4
      SN_IMPACT: '4'
      # Link to test plan documentation
      SN_TEST_PLAN: 'Activate OYI International in Airwatch'
      # Optional description of the SN change
      SN_DESCRIPTION: "Deploy OYI to Sam's Pilot Club for UAT"

      #Defaultable vars
      # Optional - target Organization Group (OG) in AirWatch where the app will reside. Defaults to InternalStore.
      #      DEFAULT_BUSINESS_TYPE: '<BUSINESS_TYPE>'
      # Optional - if no countries are found in SITES_FILE, this will be used instead (single value). Defaults to "US"
      DEFAULT_COUNTRY_CODE: 'CN'
      # Optional - version number to use instead of latest found in Proximity.
      #      DEFAULT_CURRENT_VERSION: ''
      # Optional - cocoapods version to use. Defaults to 1.8.4
      COCOAPODS_VERSION: '1.8.4'

      #Versioning vars
      # major / minor / patch / noBump > defaults to patch
      VERSION_TYPE: 'noBump'

      # Optional - weather the build will be zip aligned. Defaults to false
      ZIPALIGN_REQUIRED: false

      #Proximity related vars
      RELEASES_REPO: 'pangaea_releases'
      # Optional - Promity repo for snapshots & PRs, default is pangaea_snapshots
      SNAPSHOTS_REPO: 'pangaea_snapshots'
      # Define what type of repo you want to use (releases/snapshots)
      PROXIMITY_REPO: 'snapshots'
      # artifact group id
      NEXUS_GROUP_ID: 'IntlSamsTech'

      #BetaCrash vars
      #      betaCrashDetails:
      #        LOOPER_API_TOKEN: <PROVIDE_A_VALID_API_OKEN>
      #        APP_TITLE: "<NAME_OF_YOUR_APP>"
      #        BETACRASH_APP_ID: "<ID_OF_YOUR_APP>"

      # Application Portfolio Management
      APM_ID: 'APM0007047'

      # CN Image Auth Client ID and Secret
      CN_IMAGE_AUTH_CLIENT_ID: ENC[c7gsJUW4bWJg2IHKIcxhhLmYVh6NQxbzVzN9D+zYC4R09VQzh5cdpTOdCdyEEZYo]
      CN_IMAGE_AUTH_SECRET: ENC[exyE4QqpRmHvnPE7bkcM28gdR8Vf+pn8RnRRmRwOMKZ+BmNOdJej/2RhNgtwAALxS63uoYmnfHHwFO+S6IFzCHT1VDOHlx2lM50J3IQRlig=]

      projects:
        - rootDir: './android'
          type: android

  aos-variables:
    variables:
      PLATFORM: 'aos'
      APK_NAME: 'OYI-International'

tools:
  jdk: 8
  android:
    - tools
    - platform-tools
    - platforms;android-29
    - build-tools;29.0.3
    - extras;android;m2repository
    - ndk;21.3.6528147
  gradle: 6.7.1
  maven: 3.8.2
  nodejs: 14.17.5
  npm: 7.20.6
  sonarscanner: 4.6.2.2472

flows:
  gradlew-wrapper:
    - group("writing API secrets"):
      - 'echo "Building src/constant/Secrets.json using looper-encrypted secrets"'
      - 'echo "{ \"CN_IMAGE_AUTH_CLIENT_ID\": \"$CN_IMAGE_AUTH_CLIENT_ID\", \"CN_IMAGE_AUTH_SECRET\": \"$CN_IMAGE_AUTH_SECRET\" }" >> ../src/constant/Secrets.json'
    - group("npm install"):
        - npm ci
        - TZ='America/Chicago' npm run test:coverage
    - group ("appcenter commands"):
        - 'echo "Building android/app/src/main/assets/appcenter-config.json using looper-encrypted secrets"'
        - 'echo "{  \"app_secret\": \"$APPCENTER_SECRET_STAGE\" }" >> app/src/main/assets/appcenter-config.json'
    - group("gradle build"):
        - gradle clean
        - var (buildTask): "echo \"${task:-build}\""
        - var (buildArgs): "echo \"${args:--x lint}\""
        - call: "gradlew(task = ${buildTask}, args = ${buildArgs})"
  sonar:
    - call: sonar-fetch-remote-fix-ref
    - group("Publish Sonar"):
        - echo '${GITHUB_PR_NUMBER}'
        - if: '${GITHUB_PR_NUMBER}'
          then: (name [sonar]) sonar-scanner
            -Dproject.settings=sonar-project.properties
            -Dsonar.pullrequest.github.repository=IntlSamsTech/oyi-app
            -Dsonar.pullrequest.key=${GITHUB_PR_NUMBER}
            -Dsonar.pullrequest.branch=${GITHUB_PR_SOURCE_BRANCH}
            -Dsonar.pullrequest.base=${GITHUB_PR_TARGET_BRANCH}
            -Dsonar.branch.name=${GITHUB_PR_SOURCE_BRANCH:-${GITHUB_BRANCH_NAME}}
          else: (name [sonar]) sonar-scanner 
            -Dproject.settings=sonar-project.properties 
            -Dsonar.branch.name=${GITHUB_PR_SOURCE_BRANCH:-${GITHUB_BRANCH_NAME}}
        - hygieia.publishSonar
  sonar-fetch-remote-fix-ref:
    shell: |
      #!/bin/bash
      git fetch --no-tags --all
      if [[ ! -z "${GITHUB_PR_TARGET_BRANCH}" ]]
      then
        git fetch --no-tags origin ${GITHUB_PR_TARGET_BRANCH}:refs/remotes/origin/${GITHUB_PR_TARGET_BRANCH}
        git checkout -b remotes/origin/pr/${GITHUB_PR_NUMBER}
        git branch -D ${GITHUB_PR_TARGET_BRANCH}
      fi
